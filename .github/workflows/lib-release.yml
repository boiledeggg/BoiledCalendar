name: library-release CD

on:
  push:
    branches:
      - release/*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish-and-tag:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5
      - name: set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit test
        run: ./gradlew testDebugUnitTest

      - name: Publish and release to MavenCentral
        run: |
          ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache --stacktrace
            -PmavenCentralUsername="${{ secrets.MAVEN_CENTRAL_USERNAME }}" \
            -PmavenCentralPassword="${{ secrets.MAVEN_CENTRAL_PASSWORD }}" \
            -Psigning.keyId="${{ secrets.GPG_SIGNING_KEY_ID }}" \
            -Psigning.password="${{ secrets.GPG_SIGNING_PASSWORD }}" \
            -Psigning.secretKey='${{ secrets.GPG_SECRET_KEY }}'

      - name: Get Project Version
        id: get_version
        run: echo "project_version=$(./gradlew properties --no-daemon --console=plain | grep "^version:" | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Create Release Tag
        if: success() && steps.get_version.outputs.project_version != ''
        uses: actions/github-script@v6
        with:
          script: |
            const version = "${{ steps.get_version.outputs.project_version }}";
            const tagName = `v${version}`;
            
            try {
              // Check if the tag already exists
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`
              });
              console.log(`Tag ${tagName} already exists. Skipping tag creation.`);
            } catch (error) {
              // Create new tag if it doesn't exist
              console.log(`Creating tag ${tagName}...`);
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              console.log(`Tag ${tagName} created successfully.`);
            }

      - name: Create GitHub Release
        if: success() && steps.get_version.outputs.project_version != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.project_version }}
          name: Release v${{ steps.get_version.outputs.project_version }}
          body: |
            Official release v${{ steps.get_version.outputs.project_version }}.
            (TODO: Add changelog here)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
